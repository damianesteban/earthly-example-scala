FROM docker:19.03.7-dind

RUN apk add openjdk11

#Scala
# Defaults if not specified in --build-arg
ARG sbt_version=1.3.2
ARG sbt_home=/usr/local/sbt

# Cleverly placed here for caching reasons
RUN apk add --no-cache --update bash

# Download and extract from archive
RUN apk add --no-cache --update wget
RUN mkdir -pv "$sbt_home"
RUN wget -qO - "https://github.com/sbt/sbt/releases/download/v$sbt_version/sbt-$sbt_version.tgz" >/tmp/sbt.tgz
RUN tar xzf /tmp/sbt.tgz -C "$sbt_home" --strip-components=1
RUN ln -sv "$sbt_home"/bin/sbt /usr/bin/

# This triggers a bunch of useful downloads.
RUN sbt sbtVersion
WORKDIR /scala-example

deps:
    COPY build.sbt ./
    COPY project project
    #run sbt for caching purposes
    RUN touch a.scala && sbt compile && rm a.scala
    SAVE IMAGE

build:
    FROM +deps
    COPY src src
    RUN sbt compile

unit-test:
    FROM +deps
    COPY src src
    RUN sbt test

integration-test:
    FROM +deps
    RUN apk --update --no-cache add docker-compose
    COPY src src
    COPY docker-compose.yml ./ 
    WITH DOCKER 
        RUN docker-compose up -d && sbt test && docker-compose down 
    END

docker:
    FROM +deps
    COPY src src
    RUN sbt assembly
    ENTRYPOINT ["java","-cp","target/scala-2.12/scala-example-assembly-1.0.jar","Main"]
    SAVE IMAGE scala-example:latest

smoke-test:
    FROM +deps
    RUN apk add curl
    WITH DOCKER
        DOCKER LOAD +docker scala-example:latest
        RUN docker run --rm -d --network=host nginxdemos/hello:plain-text && sleep 5 && curl -s 0.0.0.0:32769 | grep Server
    END